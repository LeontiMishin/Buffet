<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delete-button {
            margin-left: 10px;
        }

        .btn-link:disabled {
            color: #6c757d;
            pointer-events: none;
            cursor: not-allowed;
        }
            .calendar-cell {
                cursor: pointer;
                text-align: center; 
                vertical-align: middle;
            }
        
            .today {
                background-color: #0d6efd;
                color: #fff;
            }
        
            .calendar-cell:not(.today):hover {
                background: linear-gradient(to right, #36d1dc, #5b86e5);
                color: #fff;
            }        
            
            .form-label {
                margin-top: 20px;
            }
            .ingredient-item {
                margin-bottom: 5px;
            }
    </style>
</head>

<body>

    <ul class="nav justify-content-center">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="/admin">Главная</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/admin/menus">Вывод Меню</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/admin/dishes">Блюда</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/admin/users">Пользователи</a>
        </li>
    </ul>

    <div class="container mt-5">
        <h2 class="mb-4">Календарь</h2>

        <table class="table table-bordered" id="calendar"></table>

        <form id="noteForm" style="display: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Блюдо</th>
                    </tr>
                </thead>
                <tbody id="selectedDishesList">
                    <!-- Сюда будет добавляться список выбранных блюд -->
                </tbody>
            </table>
            <label for="noteIngredient" class="form-label">Добавление:</label>
            <select class="form-select" id="noteIngredient" onchange="addDishToMenu()">
                <option selected disabled>Выберите блюдо</option>
            </select>
            <button type="button" class="btn btn-primary mt-2" id="saveMenuButton">Сохранить меню</button>
        </form>
    </div>

    <script>
      const serverUrl = 'http://localhost:3000';
      let selectedDay = null;
      let selectedDishes = [];
      

      document.addEventListener('DOMContentLoaded', function() {
        getDishes();
        createCalendar();
        getDishesForMenu();
    });

    function getDishes() {
        var url = `${serverUrl}/api/getDishes`;
        var cacheBuster = '?t=' + Date.now();
        fetch(url + cacheBuster)
            .then(response => response.json())
            .then(data => {
                console.log('Полученные данные:', data);
    
                const selectElement = document.getElementById('noteIngredient');
                data.forEach(dish => {
                    const option = document.createElement('option');
                    option.value = dish.note;
                    option.textContent = `${dish.note} - ${dish.amount} €`;
                    selectElement.appendChild(option);
                });
    
                const dateToDeleteBefore = new Date(); // Удаляем записи до текущей даты
                deleteNotesBeforeDate(dateToDeleteBefore.toISOString().split('T')[0]);
            })
            .catch(error => {
                console.error('Ошибка при получении списка блюд с сервера:', error);
            });
    }
    
    

        function openNoteForm(year, month, day) {
            const formattedDate = new Date(year, month, day).toISOString().split('T')[0];
            selectedDay = formattedDate;
            resetSelectedDishes();
            getDishesForMenu();
            document.getElementById("noteForm").style.display = "block";
        }

        function resetSelectedDishes() {
            selectedDishes = [];
            updateSelectedDishesList();
        }

        function addNote() {
            if (selectedDishes.length > 0) {
                fetch(`${serverUrl}/api/addNote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        date: selectedDay,
                        dishes: selectedDishes,
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Ответ от сервера:', data);
                    getDishesForMenu();
                })
                .catch(error => {
                    console.error('Ошибка при отправке запроса на сервер:', error);
                });
            } else {
                alert("Выберите блюдо!");
            }
        }

        function deleteIngredient(ingredientId) {
            const confirmation = confirm("Вы уверены, что хотите удалить ингредиент?");
            if (confirmation) {
                fetch('/api/deleteIngredient', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ingredientId: ingredientId
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Ответ от сервера:', data);
                        getDishesForMenu();
                    })
                    .catch(error => {
                        console.error('Ошибка при отправке запроса на сервер:', error);
                    });
            }
        }

        function isPastDate(year, month, day) {
            const currentDate = new Date();
            const selectedDate = new Date(year, month, day);
            return selectedDate < currentDate;
        }

        function addDishToMenu() {
            const selectedIngredient = document.getElementById("noteIngredient").value.trim();
            if (selectedIngredient && selectedIngredient !== "Выберите ингредиент") {
            if (!selectedDishes.includes(selectedIngredient)) {
                selectedDishes.push(selectedIngredient);

                // Отобразить выбранное блюдо в списке
                const selectedDishesList = document.getElementById("selectedDishesList");
                const listItem = document.createElement("li");
                listItem.textContent = selectedIngredient;
                listItem.classList.add("list-group-item");
                selectedDishesList.appendChild(listItem);
            } else {
                alert("Это блюдо уже добавлено!");
        }

        document.getElementById("noteIngredient").value = "Выберите ингредиент";
    } else {
        alert("Выберите ингредиент!");
    }
}

function saveMenu() {
    const formattedDate = new Date(selectedDay).toISOString().split('T')[0];

    if (selectedDishes.length > 0) {
        var url = `${serverUrl}/api/saveMenu`;
        var cacheBuster = '?t=' + Date.now();
        fetch(url + cacheBuster, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                day: formattedDate,
                note: selectedDishes,
            }),
        })
        .then(response => response.text())
        .then(data => {
            console.log('Ответ от сервера:', data);
            alert('Меню успешно сохранено в базе данных!');
            resetSelectedDishes(); 
            getDishesForMenu();
        })
        .catch(error => {
            console.error('Ошибка при отправке запроса на сервер:', error);
        });
    } else {
        alert("Выберите блюда перед сохранением!");
    }
}
              
        function updateSelectedDishesList() {
            const selectedDishesList = document.getElementById("selectedDishesList");
            selectedDishesList.innerHTML = '';
        
            selectedDishes.forEach(dish => {
                const listItem = document.createElement("li");
                listItem.textContent = `${dish.note} - ${dish.amount} €`;
                listItem.classList.add("list-group-item");

                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Удалить";
                deleteButton.addEventListener("click", () => deleteIngredient(dish));

                listItem.appendChild(deleteButton);
                selectedDishesList.appendChild(listItem);
            });
        }
        


        function getDishesForMenu() {
            if (!selectedDay) {
                console.error('Выберите дату перед запросом блюд.');
                return;
            }
        
            const formattedDate = new Date(selectedDay).toISOString().split('T')[0];
        
            fetch(`${serverUrl}/api/getDishesForDate/${formattedDate}`)
                .then(response => response.json())
                .then(data => {
                    const selectedDishesList = document.getElementById('selectedDishesList');
                    selectedDishesList.innerHTML = '';
        
                    data.forEach(dish => {
                        const row = document.createElement('tr');
                        const cell = document.createElement('td');
                        cell.textContent = dish.note;
                        row.appendChild(cell);
                        selectedDishesList.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Ошибка при получении списка блюд с сервера:', error);
                });
        }        
        document.getElementById("saveMenuButton").addEventListener("click", function() {
            saveMenu();
            getDishesForMenu();
        });


        function createCalendar() {
            const today = new Date();
            const calendarTable = document.getElementById('calendar');
            calendarTable.innerHTML = '';
            calendarTable.classList.add('table', 'table-striped', 'table-hover');
        
            for (let i = 0; i < 7; i++) {
                const date = new Date(today.getFullYear(), today.getMonth(), today.getDate() + i);
                const row = calendarTable.insertRow();
                const cell = row.insertCell();
        
                const cellText = document.createTextNode(`${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`);
                cell.appendChild(cellText);
        
                cell.classList.add('calendar-cell');
        
                if (i === 0) {
                    cell.classList.add('today');
                }
        
                cell.addEventListener('click', () => openNoteForm(date.getFullYear(), date.getMonth(), date.getDate()));
            }
            selectedDay = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString().split('T')[0];
            getDishesForMenu();
        }

        function getMenuForDay() {
            const formattedDate = new Date(selectedDay).toISOString().split('T')[0];
            var url = `${serverUrl}/api/getMenu?day=${formattedDate}`;
            var cacheBuster = '&t=' + Date.now();
            fetch(url + cacheBuster)
                .then(response => response.json())
                .then(data => {
                    selectedDishes = data.dishes;
                    updateSelectedDishesList();
                })
                .catch(error => {
                    console.error('Ошибка при получении меню с сервера:', error);
                });
        }

        function deleteNotesBeforeDate(date) {
            fetch(`${serverUrl}/api/deleteNotesBeforeDate/${date}`, {
                method: 'DELETE'
            })
            .then(response => response.text())
            .then(data => {
                console.log(data); // Выводим сообщение о количестве удаленных записей
                // Здесь можно добавить логику обновления страницы или списка записей
            })
            .catch(error => {
                console.error('Ошибка при удалении записей:', error);
            });
        }    


    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
